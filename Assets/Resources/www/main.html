<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=320" initial-scale="1.0" maximum-scale="1.0" user-scalable="0">
	<title>CrimeTime!</title>
	<script src="https://code.createjs.com/easeljs-0.8.2.min.js"></script>
	<script src="https://code.createjs.com/tweenjs-0.6.2.min.js"></script>
	<!--script src="./Resources/www/js/easeljs.js"/-->
	<style>
		html, body {
			width: 100%;
			margin: 0 auto;
			height: 100%;
		}
		canvas {
			position: absolute;
		}
	</style>
</head>
<body onresize="canvasResize();" onload="init();">
	<canvas id="canvas" width="1000" height="500"></canvas>
	<canvas id="hud" width="1000" height="500"></canvas>
	
	<!-- Script stuff to draw on canvas -->
	<script type="text/javascript">
		var rows = 5;
		var columns = 5;
		var tilesize = 100;
		var w, h, midXOffset, midYOffset;
		var canvas, topc, botc;
		var stage, top_stage, bot_stage;
		var map;
		var currentTile;
		var player = {
			"id": 0,
			"username": "Bon",
			"character": {
				"name": "BIGBOY",
				"stats": {
					"health": 5,
					"punch": 6,
					"gun": 3,
					"move": 3
				},
			}
		}

		Map.prototype = new createjs.Container();
		Map.prototype.constructor = Map;
		function Map(rows, columns){
			var pan = false;
			this.x = (tilesize*columns)/2;
			this.y = h/5;
			for(var row = 0; row < rows; row++){
				for(var col = 0; col < columns; col++){
					var tile = new createjs.Shape();
					if(row % 2 === 0 && col % 2 === 0) tile.graphics.beginFill("DeepSkyBlue");
					else if(row % 2 !== 0 && col % 2 !== 0) tile.graphics.beginFill("DeepSkyBlue");
					else tile.graphics.beginFill("AliceBlue");
					tile.graphics.drawRect(0, 0, tilesize, tilesize);
					tile.x = row*tilesize;
					tile.y = col*tilesize;
					this.addChild(tile);
					//stage.update();
				}	
			}
			this.addEventListener("click", function(e){
				var selectedTile = map.getObjectUnderPoint(e.stageX-map.x, e.stageY-map.y, 1);
				if(selectedTile !== null && !pan) {
					var circle = new createjs.Shape();
					circle.graphics.beginFill("Crimson").drawCircle(0, 0, 10);
					circle.x = e.stageX;
					circle.y = e.stageY;
					stage.addChild(circle);
					createjs.Tween.get(circle, {loop: false})
						.to({alpha: 0, x: e.stageX}, 500, createjs.Ease.getPowOut(2));
						//.to({alpha: 1, x: e.stageX}, 500, createjs.Ease.circIn(2));
					//stage.removeChild(circle);
					
					if(currentTile == undefined) {
						var selectBox = new createjs.Shape();
						selectBox.graphics.setStrokeStyle(1).beginStroke("Crimson").drawRect(0, 0, tilesize, tilesize);
						currentTile = selectBox;
						map.addChild(selectBox);
					}
					currentTile.x = selectedTile.x;
					currentTile.y = selectedTile.y;
					stage.update();
					tileSelect(selectedTile.x, selectedTile.y);
				}
			})
			this.on("mousedown", function(e){
				pan = false;
				this.parent.addChild(this);
				this.offset = {x: this.x - e.stageX, y: this.y - e.stageY};
			});

			this.on("pressmove", function(e){
				pan = true;
				this.x = e.stageX + this.offset.x;
				this.y = e.stageY + this.offset.y;
			});
			
		}

		function loadPlayers(){
			//get request data on all players
			//if(id != this player) add to players array
			//update player(s) data
		}
		
		createjs.Ticker.addEventListener("tick", tick);
		function tick(e){
			//TODO: make this performance efficient for mobile devices
			//hud should only need to update when an event triggers
			stage.update();
		}

		function init(){

			hud = document.getElementById("hud");
			canvas = document.getElementById("canvas");
			if (hud.requestFullscreen) {
				hud.requestFullscreen();
			} else if (hud.webkitRequestFullscreen) {
				hud.webkitRequestFullscreen();
			} else if (hud.mozRequestFullScreen) {
				hud.mozRequestFullScreen();
			} else if (hud.msRequestFullscreen) {
				hud.msRequestFullscreen();
			}
			stage = new createjs.Stage(canvas);
			hud_stage = new createjs.Stage(hud);
			hud_stage.addEventListener("click", function(e){
				map.dispatchEvent(e);
			})
			hud_stage.addEventListener("mousedown", function(e){
				map.dispatchEvent(e);
			});
			hud_stage.addEventListener("pressmove", function(e){
				map.dispatchEvent(e);
			});
			createjs.Touch.enable(stage);
			createjs.Ticker.setFPS(60);
			createjs.Ticker.addEventListener("tick", stage);
			canvas.width = hud.width = window.innerWidth;
			canvas.height = hud.height = window.innerHeight;
			w = canvas.width;
			h = canvas.height;
			map = new Map(5, 5);
			setup();
		}
		function setup(){
			var top = new createjs.Shape();
			var bot = new createjs.Shape();
			var bg = new createjs.Shape();
			bg.graphics.beginFill("#000").rect(0, 0, w, h);
			bg.alpha = 0.01;
			top.graphics.beginFill("Gray").drawRect(0, 0, w, h/5);
			bot.graphics.beginFill("Gray").drawRect(0, h-(h/5), w, h/5);
			stage.addChild(map);
			hud_stage.addChild(bg);
			hud_stage.addChild(top);
			hud_stage.addChild(bot);
			setupBotHud();
			setupTopHud();
		}
		function canvasResize(){
			//TODO: update w/h values and tell canvas to rerender.
			//console.log("resized!");
			//hud_stage.clear();
			//stage.clear();
			//init();
		}
		function setupTopHud(){
			//loadPlayers();
			var teamicons = [];
			if(player.character.name == "Fisticop")
				for(m = 0; m < 5; m++){
					var member_display = new createjs.Container();
					member_display.x = m*(w/5);
					member_display.y = (h/5)/2 - 10;
					var member_icon = new createjs.Shape();
					member_icon.graphics.beginFill("DimGray").drawCircle(0, 0, 40, 40);
					member_icon.x = 50;
					var member_stats = new createjs.Container();
					var name = new createjs.Text("player " + (m+1), "18px Impact", "Black");
					var health = new createjs.Container();
					var range = new createjs.Container();
					var melee = new createjs.Container();
					var movespeed = new createjs.Container();
					generatePips(health, 2, false);
					generatePips(range, 2, false);
					generatePips(melee, 2, false);
					generatePips(movespeed, 2, false);
					member_stats.x = 100;
					member_stats.y = -40;
					health.y = 25;
					range.y = health.y + 15;
					melee.y = range.y + 15;
					movespeed.y = melee. y + 15;
					member_stats.addChild(name, health, range, melee, movespeed);
					member_display.addChild(member_icon, member_stats);
					hud_stage.addChild(member_display);
					hud_stage.update();
				}
			else
				for(m = 0; m < 4; m++){
					var member_display = new createjs.Container();
					member_display.x = m*(w/5 - 20);
					member_display.y = (h/5)/2 - 10;
					var member_icon = new createjs.Shape();
					member_icon.graphics.beginFill("DimGray").drawCircle(0, 0, 40, 40);
					member_icon.x = 50;
					var member_stats = new createjs.Container();
					var name = new createjs.Text("player " + (m+1), "18px Impact", "Black");
					var health = new createjs.Container();
					var range = new createjs.Container();
					var melee = new createjs.Container();
					var movespeed = new createjs.Container();
					generatePips(health, 2, false);
					generatePips(range, 2, false);
					generatePips(melee, 2, false);
					generatePips(movespeed, 2, false);
					member_stats.x = 100;
					member_stats.y = -40;
					health.y = 25;
					range.y = health.y + 15;
					melee.y = range.y + 15;
					movespeed.y = melee. y + 15;
					member_stats.addChild(name, health, range, melee, movespeed);
					member_display.addChild(member_icon, member_stats);
					hud_stage.addChild(member_display);
					hud_stage.update();
				}
				var seperator = new createjs.Shape();
				seperator.graphics.beginFill("DimGray").drawRoundRect(0, 0, 4, (h/5) - 20, 2);
				seperator.x = w - (w/5) - 60;
				seperator.y = 10;
				var fisticop_display = new createjs.Container();
				fisticop_display.x = 5*(w/5 - 38);
				fisticop_display.y = (h/5)/2 - 10;
				var fisticop_icon = new createjs.Shape();
				fisticop_icon.graphics.beginFill("DimGray").drawCircle(0, 0, 40, 40);
				fisticop_icon.x = 0;
				
				var fisticop_stats = new createjs.Container();
				var name = new createjs.Text("player " + 5, "18px Impact", "Black");
				var health = new createjs.Container();
				var range = new createjs.Container();
				var melee = new createjs.Container();
				var movespeed = new createjs.Container();
				generatePips(health, 2, false);
				generatePips(range, 2, false);
				generatePips(melee, 2, false);
				generatePips(movespeed, 2, false);
				fisticop_stats.x = 50;
				fisticop_stats.y = -40;
				health.y = 25;
				range.y = health.y + 15;
				melee.y = range.y + 15;
				movespeed.y = melee. y + 15;
				fisticop_stats.addChild(name, health, range, melee, movespeed);
				fisticop_display.addChild(fisticop_icon, fisticop_stats);
				hud_stage.addChild(seperator, fisticop_display);
				hud_stage.update();
		}



		function setupBotHud(){
			var player_icon = new createjs.Shape();
			var player_icon_img = new Image();
			player_icon_img.onload = function(){
				
			}

			player_icon_img.src = "./sprites/josephine_player_icon.png";
			player_icon.graphics.beginFill("DimGray").drawCircle(0, 0, 100, 100);
			player_icon.x = 120;
			player_icon.y = h-(h/5) + 50;
			//add mask for player sprite/portrait
			// var player_icon_img_bitmap = new createjs.Bitmap(player_icon_img);
			// player_icon_img_bitmap.x = 32;
			// player_icon_img_bitmap.y = h-(h/5) - 35;
			// player_icon_img_bitmap.scaleX = player_icon_img_bitmap.scaleY = 0.35;
			var player_stats = new createjs.Container();
			var name = new createjs.Text(player.username, "bold 30px Impact", "Black");
			var health = new createjs.Container();
			var range = new createjs.Container();
			var melee = new createjs.Container();
			var movespeed = new createjs.Container();
			generatePips(health, player.character.stats.health, true);
			generatePips(range, player.character.stats.gun, true);
			generatePips(melee, player.character.stats.punch, true);
			generatePips(movespeed, player.character.stats.move, true);
			health.y = 40;
			range.y = health.y + 25;
			melee.y = range.y + 25;
			movespeed.y = melee. y + 25;
			player_stats.addChild(name, health, range, melee, movespeed);
			player_stats.x = 230;
			player_stats.y = h-(h/5) + 5;
			//TODO: Should have bottom section of HUD be it's own container, then child
			//everything that's setup here. Makes positioning items easiers
			hud_stage.addChild(player_icon, player_stats);
			hud_stage.update();
		}

		function generatePips(stat, pipAmt, isPlayer){
			for(var i = 0; i < pipAmt; i++){
				var pip = new createjs.Shape();
				if(isPlayer) pip.graphics.beginFill("DimGray").drawRoundRect(11*i, 0, 9, 20, 5);
				else pip.graphics.beginFill("DimGray").drawRoundRect(10*i, 0, 8, 13, 4);
				stat.addChild(pip);
			}
		}

		function tileSelect(x, y){
			console.log("Selected : " + (x)/tilesize + ", " + (columns - (y)/tilesize - 1));
			
		}
	</script>
</body>
</html>